name: Build auxiliary Docker images

on:
  push:
    branches:
      - main
      - ci/improve-ci-cd-performance
    paths:
      - 'docker/Dockerfile.**'

jobs:
  plan:
    name: Plan Docker image builds
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Detect changed Dockerfiles
        uses: tj-actions/changed-files@v47
        id: changed
        with:
          files: docker/Dockerfile.**

      - name: Set build matrix
        id: set-matrix
        shell: bash
        run: |
          # Build a matrix from changed dockerfiles that match docker/Dockerfile.*
          # Image name becomes loci-<suffix>
          declare -A seen=()
          items=()

          # Print all changed files for debugging
          echo "Changed files:" 
          echo "${{ steps.changed.outputs.all_changed_files }}"

          for f in ${{ steps.changed.outputs.all_changed_files }}; do
            case "$f" in
              docker/Dockerfile.*)
                suffix="${f##docker/Dockerfile.}"
                image="loci-${suffix}"

                # Deduplicate if the same file appears multiple times
                if [[ -z "${seen["$f"]}" ]]; then
                  seen["$f"]=1
                  items+=("{\"dockerfile\":\"$f\",\"image\":\"$image\"}")
                fi
                ;;
            esac
          done

          if [[ ${#items[@]} -eq 0 ]]; then
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
          else
            printf 'matrix={"include":[%s]}\n' "$(IFS=,; echo "${items[*]}")" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build and push Docker images
    needs: plan
    if: ${{ fromJSON(needs.plan.outputs.matrix).include != null && fromJSON(needs.plan.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.plan.outputs.matrix) }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          provenance: false
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          tags: ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
